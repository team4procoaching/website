name: Semgrep

# ============================================================================
# SCAN STRATEGY & TRIGGERS
# ============================================================================
# 1. Pull Request (PR â†’ main):
#    - Automatic diff-aware scanning (changed files only)
#    - Blocks merge on critical findings
#    - Semgrep automatically detects which files need scanning
#
# 2. Push (main branch):
#    - Updates GitHub Security Tab
#    - Full scan of current state
#
# 3. Scheduled (Weekly):
#    - Monday 04:30 UTC - Full scan for drift detection
#    - Detects new vulnerabilities in existing patterns
#
# 4. Manual Trigger:
#    - On-demand scan via GitHub UI
#
# RESOURCE OPTIMIZATION:
# - Bot commits are skipped (Renovate, Dependabot)
# - Semgrep's built-in diff-aware scanning (no manual file detection needed)
# - Automatic concurrency control (cancel-in-progress)
#
# CONFIGURATION FILES:
# - .semgrepignore: Exclusion patterns (dependencies, build outputs, etc.)
# ============================================================================

on:
  # Scan on Pull Requests against main
  pull_request:
    branches:
      - main

  # Scan on Push to main (after merge)
  push:
    branches:
      - main

  # Weekly scan: Every Monday at 04:30 UTC
  schedule:
    - cron: "30 4 * * 1"

  # Manual trigger via GitHub UI
  workflow_dispatch: {}

# ============================================================================
# PERMISSIONS (Least Privilege Principle)
# ============================================================================
# Minimal permissions for security best practices
permissions:
  contents: read # Required: Read repository code
  security-events: write # Required: Write SARIF results to Security tab

# ============================================================================
# CONCURRENCY (Prevents Parallel Runs)
# ============================================================================
# Cancels older runs when new ones are triggered (saves CI minutes)
concurrency:
  group: semgrep-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

# ============================================================================
# JOBS
# ============================================================================
jobs:
  semgrep:
    name: Security Scan
    runs-on: ubuntu-latest

    # Official Semgrep Docker image
    # Contains all necessary dependencies and rules
    container:
      image: semgrep/semgrep

    # ========================================================================
    # BOT FILTER: Skip automatic commits
    # ========================================================================
    # Renovate and Dependabot updates don't need Semgrep scans
    # (covered by PR review and their own security checks)
    if: github.actor != 'dependabot[bot]' && github.actor != 'renovate[bot]'

    steps:
      # ======================================================================
      # CHECKOUT: Retrieve repository code
      # ======================================================================
      # v4 is the current stable version
      # Semgrep needs access to the complete code
      - name: Checkout Repository
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6

      # ======================================================================
      # SEMGREP SCAN
      # ======================================================================
      # 'semgrep ci' is the official command for CI/CD integration
      #
      # What 'semgrep ci' does automatically:
      # - Diff-aware scanning on PRs (scans only changed files)
      # - Loads rulesets from Semgrep Registry
      # - Respects .semgrepignore
      # - Generates SARIF output
      # - Exit code 1 on findings (= job fails automatically)
      #
      # SARIF Output:
      # - Standardized format for security tools
      # - Understood by GitHub Security tab
      # - Enables code navigation and filtering
      - name: Run Semgrep Scan
        run: semgrep ci --sarif --output=semgrep.sarif
        env:
          # ================================================================
          # SEMGREP_APP_TOKEN: Connection to Semgrep AppSec Platform
          # ================================================================
          # Generate token: Semgrep AppSec Platform > Settings
          # Store as GitHub Secret: Settings > Secrets > Actions
          #
          # Platform benefits:
          # - Central rule management
          # - Custom rules and policies
          # - Findings history and trends
          # - Team collaboration
          SEMGREP_APP_TOKEN: ${{ secrets.SEMGREP_APP_TOKEN }}

      # ======================================================================
      # UPLOAD SARIF: Results to GitHub Security tab
      # ======================================================================
      # Uploads scan results even if the scan had findings
      #
      # GitHub Security features:
      # - Code Scanning Alerts tab
      # - Inline PR comments (depending on configuration)
      # - Security Overview Dashboard
      # - Branch Protection integration
      #
      # 'if: always()' ensures results are uploaded
      # even if the scan failed (findings = exit code 1)
      - name: Upload SARIF to GitHub Security
        uses: github/codeql-action/upload-sarif@5d4e8d1aca955e8d8589aabd499c5cae939e33c7 # v4
        with:
          sarif_file: semgrep.sarif
        if:
          always() && (github.event_name != 'pull_request' ||
          github.event.pull_request.head.repo.fork != true)
