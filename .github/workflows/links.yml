name: Link Check

# ============================================================================
# SCAN STRATEGY & RESOURCE OPTIMIZATION
# ============================================================================
# 1. Pull Request (PR â†’ main):
#    - Quick internal link validation (30-60s)
#    - Checks local links, assets (CSS/JS/images/videos)
#    - Acts as quality gate to prevent broken references
#
# 2. Push (main branch):
#    - Same as PR - validates internal integrity
#
# 3. Scheduled (Weekly):
#    - Monday 02:00 UTC - full scan including external links
#    - Checks for link rot and external resource availability
#    - Continues on error to ensure Report/Issue creation happens
#    - Uses realistic browser User-Agent to avoid bot blocks
#
# RESOURCE OPTIMIZATION:
# - Skips bot commits (Renovate, Dependabot) to save CI minutes
# - Only scans when relevant files changed (PR/Push)
# - Cancels outdated runs automatically via concurrency groups
# - Timeout: 10min (internal: ~1min, external: ~5-10min)
# - Concurrency: 20 (internal), 5 (external - good citizen)
#
# REPORTING:
# - PR/Push: Results visible in Job Summary (no download needed)
# - Scheduled: Creates/Updates GitHub Issue with preview of broken links
#   and a link to the full report artifact for detailed analysis
#
# EDGE CASES HANDLED:
# - New Repository: Falls back to scanning all files if git history unavailable
# - Empty Commits: Skips scan if no relevant files changed
# - Bot Commits: Filtered early to save CI minutes
# - No Links Found: Passes gracefully (new projects, landing pages)
# - Squash Merges: Uses fetch-depth: 0 for robust PR diffs
# - Rate Limiting: External sites returning 429 are treated as valid
#
# CONFIGURATION FILES:
# - .lycheeignore: Patterns to exclude (social media, localhost, examples)
# ============================================================================

on:
  pull_request:
    branches:
      - main

  push:
    branches:
      - main

  schedule:
    # Syntax: Minute Hour Day Month Weekday
    # Every Monday at 2:00 a.m. UTC
    - cron: "0 2 * * 1"

# ============================================================================
# PERMISSIONS (Least Privilege Principle)
# ============================================================================
permissions:
  contents: read # Required: Read repository code
  issues: write # Required: Create/update issues for scheduled scan failures
  actions: read # Required: Access workflow metadata for artifact links

# ============================================================================
# CONCURRENCY (Prevent Duplicate Runs)
# ============================================================================
concurrency:
  group: link-check-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

# ============================================================================
# ENVIRONMENT VARIABLES
# ============================================================================
env:
  NODE_VERSION: "22"

  # Centralized Lychee configuration (DRY principle)
  #
  # BASE ARGUMENTS EXPLAINED (shared across all scan modes):
  #
  # --verbose
  #   Provides detailed output for debugging link check issues
  #
  # --no-progress
  #   Disables progress bars for cleaner CI logs
  #
  # --no-ignore
  #   Don't use .lycheeignore file (we control exclusions explicitly here)
  #
  # --user-agent 'Mozilla/5.0...'
  #   Mimics a real browser to avoid 403 blocks from social media sites
  #   and other services that block automated requests
  #
  # --accept '100..=103,200..=299,429'
  #   Defines which HTTP status codes are considered valid/successful:
  #   â€¢ 100-103: Informational responses (Continue, Switching Protocols, Processing, Early Hints)
  #   â€¢ 200-299: Success responses (OK, Created, Accepted, No Content, etc.)
  #   â€¢ 429: Rate limit exceeded - accepted as valid because it's temporary, not a broken link
  #   This prevents false positives when external sites temporarily rate-limit requests
  #
  # --exclude-all-private
  #   Skips checking of private IP ranges to avoid false negatives:
  #   â€¢ Combines: --exclude-private, --exclude-link-local, --exclude-loopback
  #   â€¢ Ignores: localhost, 127.0.0.1, 10.x.x.x, 192.168.x.x, 169.254.x.x, etc.
  #   â€¢ Use case: Documentation often references local development URLs that shouldn't be checked
  #
  # --skip-missing
  #   Continues execution even if some input files don't exist:
  #   â€¢ Without this flag: Lychee exits with error if an input file is missing
  #   â€¢ With this flag: Missing files are skipped, scanning continues with available files
  #   â€¢ Use case: Handles dynamic build processes where not all files may exist in every run
  #
  # --require-https
  #   Treats HTTP links as errors when HTTPS alternative is available:
  #   â€¢ Enforces security best practices by preferring encrypted connections
  #   â€¢ Flags HTTP links that could/should be HTTPS
  #   â€¢ Use case: Ensures modern security standards in production websites
  #
  # --github-token
  #   Provides GitHub API authentication to avoid rate limiting:
  #   â€¢ GitHub API has strict rate limits for unauthenticated requests (60/hour)
  #   â€¢ With token: Rate limit increases to 5,000 requests/hour
  #   â€¢ Use case: Essential when checking repositories with many GitHub links
  LYCHEE_BASE_ARGS: >-
    --verbose --no-progress --no-ignore --user-agent 'Mozilla/5.0 (Macintosh; Intel Mac OS X
    10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/131.0.0.0 Safari/537.36' --accept
    '100..=103,200..=299,429' --exclude-all-private --skip-missing --require-https --github-token
    '${{ secrets.GITHUB_TOKEN }}'

# ============================================================================
# JOBS
# ============================================================================
jobs:
  # ==========================================================================
  # JOB 1: DETECT CHANGES
  # ==========================================================================
  # Purpose: Determine if content or asset files have changed
  # Strategy: Uses 'tj-actions/changed-files' for robust git diff logic
  # Skip: Bot commits to save CI minutes (Renovate, Dependabot)
  # Output: Boolean flag for subsequent jobs
  # Fallback: Scans everything if file detection fails (new repository)
  # ==========================================================================
  check-changes:
    name: Detect Changes
    # Skip bot commits to save resources
    if: >-
      github.actor != 'renovate[bot]' && github.actor != 'dependabot[bot]'
    runs-on: ubuntu-latest
    timeout-minutes: 2

    outputs:
      # Map the output to the job output (via scan-flag step)
      should-scan: ${{ steps.scan-flag.outputs.should-scan }}

    steps:
      - name: Checkout Repository
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6
        with:
          # Full history ensures robust diffs for PRs (handles squash merges)
          # For scheduled runs, this provides complete git history
          fetch-depth: 0

      - name: Detect Changed Files
        id: changed-files
        uses: tj-actions/changed-files@24d32ffd492484c1d75e0c0b894501ddb9d30d62 # v47
        with:
          # Monitor content files, components, configuration, and workflow itself
          # Using glob patterns for readability (more maintainable than regex)
          files: |
            **/*.{astro,md,mdx,html}
            **/*.{css,js,ts,jsx,tsx}
            public/**
            src/content/**
            src/pages/**
            src/layouts/**
            src/components/**
            astro.config.mjs
            package.json
            pnpm-lock.yaml
            .github/workflows/links.yml
        # Fallback: If action fails (e.g., new repo with no git history),
        # continue workflow and default to scanning (safer than skipping)
        continue-on-error: true

      - name: Set Scan Flag
        id: scan-flag
        run: |
          # If changed-files succeeded, use its output
          # If it failed (new repo, no history), default to scanning
          if [[ "${{ steps.changed-files.outcome }}" == "success" ]]; then
            echo "should-scan=${{ steps.changed-files.outputs.any_changed }}" >> $GITHUB_OUTPUT
            echo "âœ… File change detection successful"
          else
            echo "should-scan=true" >> $GITHUB_OUTPUT
            echo "âš ï¸  File change detection failed (possibly new repository) - scanning all files"
          fi

  # ==========================================================================
  # JOB 2: LINK CHECK & REPORTING
  # ==========================================================================
  # Purpose: Validate links and assets, report failures
  # Modes:
  #   - PR/Push: Internal links only (fast, ~1min) - --offline flag
  #   - Scheduled: Full scan including external links (~5-10min)
  # Reporting:
  #   - Always creates Job Summary for immediate visibility
  #   - Scheduled failures create/update GitHub Issue with preview
  #   - Full report available as artifact (30-day retention)
  # ==========================================================================
  link-check:
    name: >-
      ${{ github.event_name == 'schedule' 
          && 'Full Link Check (Internal + External)' 
          || 'Check Internal Links & Assets' }}
    needs: check-changes
    runs-on: ubuntu-latest
    timeout-minutes: 10

    # Execute scan if:
    # A) Relevant files changed (PR or Push) OR
    # B) Scheduled run (always scans, ignores file changes)
    if: >-
      needs.check-changes.outputs.should-scan == 'true' || github.event_name == 'schedule'

    steps:
      - name: Checkout Repository
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6

      - name: Setup pnpm
        uses: pnpm/action-setup@41ff72655975bd51cab0327fa583b6e92b6d3061 # v4

      - name: Setup Node.js
        uses: actions/setup-node@395ad3262231945c25e8478fd5baf05154b1d79f # v6
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: pnpm

      - name: Install Dependencies
        run: pnpm install --frozen-lockfile

      - name: Build Astro Site
        run: pnpm run build

      - name: Check Links (Lychee)
        id: lychee
        uses: lycheeverse/lychee-action@a8c4c7cb88f0c7386610c35eb25108e448569cb0 # v2
        with:
          # MODE-SPECIFIC ARGUMENTS:
          #
          # The base arguments from LYCHEE_BASE_ARGS are applied to all scan modes.
          # Below we add mode-specific parameters based on the trigger event.
          #
          # ========================================================================
          # PR/PUSH MODE (--offline flag)
          # ========================================================================
          # Purpose: Fast internal link validation (~30-60 seconds)
          # Behavior:
          #   - No external HTTP requests made
          #   - Only checks links within the built site
          #   - Validates relative paths, anchors, and local assets
          #   - Acts as quality gate to prevent broken internal references
          # Concurrency: 20 (safe for local filesystem operations)
          #
          # ========================================================================
          # SCHEDULED MODE (online with retries)
          # ========================================================================
          # Purpose: Comprehensive external link validation (~5-10 minutes)
          # Additional Arguments:
          #   --max-retries 3
          #     Retry failed requests up to 3 times before marking as broken
          #     Handles transient network issues and temporary server problems
          #
          #   --retry-wait-time 2
          #     Wait 2 seconds between retry attempts
          #     Gives servers time to recover from temporary issues
          #
          #   --timeout 30
          #     30-second timeout per individual HTTP request
          #     Prevents hanging on unresponsive servers
          #
          # Concurrency: 5 (good citizen, avoids overwhelming external sites)
          #
          # ========================================================================
          # ADDITIONAL NOTES:
          # ========================================================================
          # - If Astro generates absolute URLs (e.g., site: 'https://example.com'
          #   in astro.config.mjs), you may need to add:
          #   --base-url 'https://example.com'
          #   This treats absolute URLs as local for offline mode
          #
          # - For additional exclusions (social media, examples), create a
          #   .lycheeignore file in the repository root
          args: |
            ${{ env.LYCHEE_BASE_ARGS }}
            ${{ github.event_name != 'schedule' && '--offline' || '--max-retries 3 --retry-wait-time 2 --timeout 30' }}
            --max-concurrency ${{ github.event_name == 'schedule' && '5' || '20' }}
            './dist/**/*.html'

          # Don't fail if no links are found (e.g., new project, landing page only)
          # This prevents workflow failures in early project stages
          failIfEmpty: false

          # PR/Push: Fail immediately on broken links (blocks merge via branch protection)
          # Scheduled: Continue to allow issue creation (don't mark workflow as failed)
          fail: ${{ github.event_name != 'schedule' }}

        # Allow scheduled scans to continue even on failure
        # This keeps the workflow green while still creating issues for visibility
        continue-on-error: ${{ github.event_name == 'schedule' }}

      - name: Upload Lychee Report
        if: always()
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6
        with:
          name: lychee-report
          path: lychee/out.md
          retention-days: 30

      - name: Create Job Summary
        if: always()
        run: |
          echo "## ðŸ”— Link Check Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Add scan metadata
          echo "**Scan Type:** ${{ github.event_name == 'schedule' && 'Full (Internal + External)' || 'Internal Links Only' }}" >> $GITHUB_STEP_SUMMARY
          echo "**Triggered by:** ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Include Lychee report if available
          if [ -f lychee/out.md ]; then
            cat lychee/out.md >> $GITHUB_STEP_SUMMARY
          else
            echo "â„¹ï¸ No detailed report generated." >> $GITHUB_STEP_SUMMARY
          fi

      - name: Report Scheduled Scan Failures
        # IMPORTANT: We use steps.lychee.outcome instead of if: failure()
        # because continue-on-error marks the step as 'success' in the job context
        # but preserves the actual outcome for conditional checks
        if: steps.lychee.outcome == 'failure' && github.event_name == 'schedule'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          set -euo pipefail

          # 1. PREPARE REPORT SNIPPET
          # Extract first 50 lines for preview (keeps issue readable)
          # Full report available via artifact download
          REPORT_SNIPPET="(No report file found)"
          if [[ -f lychee/out.md ]]; then
            REPORT_SNIPPET=$(sed -n '1,50p' lychee/out.md)
          fi

          RUN_URL="$GITHUB_SERVER_URL/$GITHUB_REPOSITORY/actions/runs/$GITHUB_RUN_ID"
          NOW=$(date -Iseconds)

          # 2. FIND EXISTING ISSUE
          # Check if an open issue with 'link-check' label already exists
          # Returns issue number if found, empty string otherwise
          EXISTING_ISSUE=$(gh issue list \
            --label "link-check" \
            --state open \
            --json number \
            --jq '.[0].number')

          # 3. CONSTRUCT BODY TEXT
          # Shared content for both new issues and update comments
          # Uses heredoc for clean multi-line formatting
          BODY_CONTENT=$(cat <<EOF
          The weekly link check has detected broken links.

          - **Scan Date:** ${NOW}
          - **Workflow Run:** [View Logs & Artifacts](${RUN_URL})

          ### ðŸ” Report Preview (First 50 lines)
          \`\`\`
          ${REPORT_SNIPPET}
          \`\`\`

          _(Download the full 'lychee-report' artifact from the workflow run for complete details)_
          EOF
          )

          # 4. CREATE OR UPDATE ISSUE
          if [ -z "$EXISTING_ISSUE" ]; then
            echo "No existing issue found. Creating new issue..."
            gh issue create \
              --title "ðŸ”— Link Check Weekly Scan: Broken Links Detected" \
              --label "maintenance,automated,link-check" \
              --body "**Automated Link Check Alert**

          $BODY_CONTENT

          **Action Required:**
          1. Review the report preview above or download the full artifact
          2. Fix or remove broken links
          3. Close this issue when resolved

          **Common Issues:**
          - External websites moved or taken offline
          - Missing images or assets
          - Incorrect relative paths

          ---
          *This issue was automatically created by the Link Check workflow.*"
          else
            echo "Found existing issue #$EXISTING_ISSUE. Adding comment..."
            gh issue comment "$EXISTING_ISSUE" \
              --body "**Weekly Scan Update**

          $BODY_CONTENT"
          fi

  # ==========================================================================
  # JOB 3: STATUS CHECK (GitHub Branch Protection)
  # ==========================================================================
  # Purpose: Provide consistent status check for branch protection rules
  # Behavior:
  #   - âœ… GREEN: Scan passed or skipped (no relevant changes)
  #   - âœ… GREEN: Bot commits (already filtered, but double-check for clarity)
  #   - âŒ RED: Scan found broken links or was cancelled
  # Always runs: Even when previous jobs are skipped or cancelled
  # Note: Only runs for PR/Push (not scheduled scans)
  # ==========================================================================
  link-check-status:
    name: Link Check Status
    needs: link-check
    # Run only for PR/Push events (not for scheduled scans)
    # IMPORTANT: Use always() to handle manual cancellations
    # This ensures branch protection always receives a status
    if: always() && github.event_name != 'schedule'
    runs-on: ubuntu-latest
    timeout-minutes: 1

    steps:
      - name: Evaluate Scan Results
        run: |
          RESULT="${{ needs.link-check.result }}"

          # Debug output for transparency in workflow logs
          echo "Link Check Result: $RESULT"

          # Evaluate result using case statement for clarity
          case "$RESULT" in
            success)
              echo "âœ… Link Check completed successfully - no broken links found"
              exit 0
              ;;
            skipped)
              echo "â­ï¸  Link Check skipped - no relevant files changed"
              exit 0
              ;;
            cancelled)
              echo "âŒ Link Check was cancelled"
              exit 1
              ;;
            failure)
              echo "âŒ Link Check detected broken links or missing assets"
              echo "Review the workflow logs and Job Summary before merging"
              exit 1
              ;;
            *)
              echo "âš ï¸  Unexpected result: $RESULT"
              exit 1
              ;;
          esac
